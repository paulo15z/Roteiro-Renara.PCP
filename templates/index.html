<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roteiro de ProduÃ§Ã£o Â· PCP</title>
<style>
  :root {
    --bg:       #f0f2f5;
    --card:     #ffffff;
    --border:   #dde1e7;
    --primary:  #1a3a6b;
    --accent:   #2563eb;
    --success:  #16a34a;
    --danger:   #dc2626;
    --warn:     #d97706;
    --text:     #1e2532;
    --muted:    #6b7280;
    --font:     'Segoe UI', system-ui, sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }

  /* â”€â”€ Header â”€â”€ */
  header {
    background: var(--primary);
    color: #fff;
    padding: 0 32px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,.18);
  }
  header h1 { font-size: 1rem; font-weight: 600; letter-spacing: .03em; }
  header span { font-size: .78rem; opacity: .65; }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs { display: flex; gap: 2px; background: var(--primary); padding: 0 32px; }
  .tab {
    padding: 10px 20px;
    font-size: .85rem;
    font-weight: 500;
    color: rgba(255,255,255,.6);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: .15s;
    user-select: none;
  }
  .tab:hover { color: #fff; }
  .tab.active { color: #fff; border-bottom-color: #60a5fa; }

  /* â”€â”€ Main â”€â”€ */
  main { max-width: 1100px; margin: 32px auto; padding: 0 24px; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* â”€â”€ Cards â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 20px;
  }
  .card h2 { font-size: .95rem; font-weight: 600; color: var(--primary); margin-bottom: 16px; }

  /* â”€â”€ Upload area â”€â”€ */
  .drop-area {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: .2s;
  }
  .drop-area:hover, .drop-area.over { border-color: var(--accent); background: #eff6ff; }
  .drop-area svg { width: 48px; height: 48px; color: var(--muted); margin-bottom: 12px; }
  .drop-area p { color: var(--muted); font-size: .88rem; }
  .drop-area strong { color: var(--accent); }
  #file-input { display: none; }
  #file-name { margin-top: 10px; font-size: .85rem; color: var(--accent); font-weight: 500; }

  /* â”€â”€ Btn â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 9px 20px; border-radius: 6px; border: none;
    font-size: .88rem; font-weight: 600; cursor: pointer; transition: .15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
  .btn-sm { padding: 5px 12px; font-size: .78rem; font-weight: 500; }
  .btn-success { background: var(--success); color: #fff; }
  .btn-success:hover { background: #15803d; }
  .btn-danger  { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .btn-danger:hover  { background: #fef2f2; }

  /* â”€â”€ Progress â”€â”€ */
  #progress-wrap { display: none; margin-top: 16px; }
  .progress-bar { height: 6px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
  .progress-fill {
    height: 100%; width: 0%; background: var(--accent);
    border-radius: 99px;
    transition: width .3s;
    animation: pulse-bar 1.5s ease-in-out infinite;
  }
  @keyframes pulse-bar { 0%,100%{opacity:1} 50%{opacity:.6} }
  #progress-label { font-size: .8rem; color: var(--muted); margin-top: 6px; }

  /* â”€â”€ Alert â”€â”€ */
  .alert {
    display: none; padding: 12px 16px; border-radius: 6px;
    font-size: .85rem; margin-top: 16px; border-left: 4px solid;
  }
  .alert-err  { background: #fef2f2; border-color: var(--danger); color: #991b1b; }
  .alert-ok   { background: #f0fdf4; border-color: var(--success); color: #166534; }

  /* â”€â”€ Resultado â”€â”€ */
  #resultado { display: none; }
  .stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
  .stat-box {
    flex: 1; min-width: 140px;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 16px;
    text-align: center;
  }
  .stat-box .num { font-size: 2rem; font-weight: 700; color: var(--primary); }
  .stat-box .lbl { font-size: .78rem; color: var(--muted); margin-top: 2px; }

  /* â”€â”€ Resumo roteiros â”€â”€ */
  .roteiro-list { display: flex; flex-direction: column; gap: 8px; }
  .roteiro-row {
    display: flex; align-items: center; gap: 10px;
    font-size: .83rem;
  }
  .roteiro-row .rota { font-family: 'Consolas', monospace; color: var(--primary); flex: 1; }
  .roteiro-row .bar-wrap { flex: 2; height: 8px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
  .roteiro-row .bar-fill { height: 100%; background: var(--accent); border-radius: 99px; transition: width .5s; }
  .roteiro-row .qtd { width: 32px; text-align: right; color: var(--muted); font-weight: 600; }

  /* â”€â”€ PrÃ©via tabela â”€â”€ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: .82rem; }
  thead th {
    background: var(--primary); color: #fff;
    padding: 9px 12px; text-align: left;
    font-weight: 600; white-space: nowrap;
  }
  tbody tr:nth-child(even) { background: var(--bg); }
  tbody td { padding: 7px 12px; border-bottom: 1px solid var(--border); }
  td.rota-cell {
    font-family: 'Consolas', monospace; font-size: .78rem;
    color: var(--primary); font-weight: 600;
    background: #fffbeb;
    white-space: nowrap;
  }

  /* â”€â”€ HistÃ³rico â”€â”€ */
  .hist-table { width: 100%; border-collapse: collapse; font-size: .84rem; }
  .hist-table thead th {
    background: var(--primary); color: #fff;
    padding: 9px 14px; text-align: left; font-weight: 600;
  }
  .hist-table tbody tr:nth-child(even) { background: var(--bg); }
  .hist-table tbody td { padding: 9px 14px; border-bottom: 1px solid var(--border); }
  .hist-empty { color: var(--muted); font-size: .88rem; padding: 24px 0; text-align: center; }

  /* â”€â”€ Badge â”€â”€ */
  .badge {
    display: inline-block; padding: 2px 8px;
    border-radius: 99px; font-size: .72rem; font-weight: 600;
  }
  .badge-blue { background: #dbeafe; color: #1e40af; }

  /* â”€â”€ Sector chips â”€â”€ */
  .chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 4px; }
  .chip {
    padding: 3px 10px; border-radius: 4px; font-size: .72rem; font-weight: 700;
    letter-spacing: .04em;
  }
  .chip-COR  { background:#dbeafe; color:#1e40af; }
  .chip-BOR  { background:#dcfce7; color:#166534; }
  .chip-XBOR { background:#d1fae5; color:#065f46; }
  .chip-DUP  { background:#fef9c3; color:#854d0e; }
  .chip-USI  { background:#ffedd5; color:#9a3412; }
  .chip-FUR  { background:#fee2e2; color:#991b1b; }
  .chip-CAX  { background:#f3e8ff; color:#6b21a8; }
  .chip-MAR  { background:#fce7f3; color:#9d174d; }
  .chip-XMAR { background:#fce7f3; color:#831843; }
  .chip-EXP  { background:#e0f2fe; color:#0c4a6e; }

  .arrow { color: #94a3b8; font-size: .8rem; }
</style>
</head>
<body>

<header>
  <h1>âš™ Roteiro de ProduÃ§Ã£o Â· PCP</h1>
  <span id="clock"></span>
</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('upload')">Processar Arquivo</div>
  <div class="tab" onclick="showTab('historico')">HistÃ³rico</div>
</div>

<main>

  <!-- â•â• PAINEL UPLOAD â•â• -->
  <div class="panel active" id="panel-upload">

    <div class="card">
      <h2>Upload do arquivo Dinabox</h2>
      <div class="drop-area" id="drop-area" onclick="document.getElementById('file-input').click()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
        </svg>
        <p>Arraste um arquivo aqui ou <strong>clique para selecionar</strong></p>
        <p style="margin-top:6px">CSV Â· XLS Â· XLSX exportado pelo Dinabox</p>
        <div id="file-name"></div>
      </div>
      <input type="file" id="file-input" accept=".csv,.xls,.xlsx">

      <div id="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div id="progress-label">Processandoâ€¦</div>
      </div>

      <div class="alert alert-err" id="alert-err"></div>
      <div class="alert alert-ok"  id="alert-ok"></div>

      <div style="margin-top:18px; display:flex; gap:10px; align-items:center;">
        <button class="btn btn-primary" id="btn-processar" onclick="processar()" disabled>
          â–¶ Gerar Roteiro
        </button>
        <span id="pid-badge"></span>
      </div>
    </div>

    <!-- Resultado -->
    <div id="resultado">
      <div class="card">
        <h2>Resultado</h2>
        <div class="stats" id="stats"></div>
        <button class="btn btn-success" id="btn-download">â¬‡ Baixar XLSX</button>
      </div>

      <div class="card">
        <h2>DistribuiÃ§Ã£o de Roteiros</h2>
        <div class="roteiro-list" id="roteiro-list"></div>
      </div>

      <div class="card">
        <h2>PrÃ©via das peÃ§as <span style="font-weight:400;color:var(--muted);font-size:.8rem">(primeiras 50)</span></h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>DescriÃ§Ã£o da PeÃ§a</th>
                <th>Local</th>
                <th>Roteiro</th>
              </tr>
            </thead>
            <tbody id="previa-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• PAINEL HISTÃ“RICO â•â• -->
  <div class="panel" id="panel-historico">
    <div class="card">
      <h2>Pedidos processados</h2>
      <table class="hist-table" id="hist-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Arquivo</th>
            <th>Data</th>
            <th>PeÃ§as</th>
            <th>AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="hist-tbody">
          <tr><td colspan="5" class="hist-empty">Carregandoâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<script>
// â”€â”€ Clock â”€â”€
function tick() {
  const d = new Date();
  document.getElementById('clock').textContent =
    d.toLocaleDateString('pt-BR') + '  ' + d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
}
tick(); setInterval(tick, 10000);

// â”€â”€ Tabs â”€â”€
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'historico') carregarHistorico();
}

// â”€â”€ Upload â”€â”€
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
let arquivoAtual = null;
let pidAtual = null;

['dragenter','dragover'].forEach(e => dropArea.addEventListener(e, ev => {
  ev.preventDefault(); dropArea.classList.add('over');
}));
['dragleave','drop'].forEach(e => dropArea.addEventListener(e, ev => {
  ev.preventDefault(); dropArea.classList.remove('over');
}));
dropArea.addEventListener('drop', ev => {
  const f = ev.dataTransfer.files[0];
  if (f) setFile(f);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) setFile(fileInput.files[0]);
});

function setFile(f) {
  arquivoAtual = f;
  document.getElementById('file-name').textContent = 'ðŸ“„ ' + f.name;
  document.getElementById('btn-processar').disabled = false;
  esconderResultado();
  clearAlerts();
}

function clearAlerts() {
  ['alert-err','alert-ok'].forEach(id => {
    const el = document.getElementById(id);
    el.style.display = 'none'; el.textContent = '';
  });
}

function showErr(msg) {
  const el = document.getElementById('alert-err');
  el.textContent = 'âš  ' + msg; el.style.display = 'block';
}

function showOk(msg) {
  const el = document.getElementById('alert-ok');
  el.textContent = 'âœ“ ' + msg; el.style.display = 'block';
}

function esconderResultado() {
  document.getElementById('resultado').style.display = 'none';
}

// â”€â”€ Processar â”€â”€
async function processar() {
  if (!arquivoAtual) return;
  clearAlerts();
  esconderResultado();

  // Progress
  const pw = document.getElementById('progress-wrap');
  const pf = document.getElementById('progress-fill');
  const pl = document.getElementById('progress-label');
  pw.style.display = 'block';
  pf.style.width = '30%';
  pl.textContent = 'Enviando arquivoâ€¦';
  document.getElementById('btn-processar').disabled = true;

  const fd = new FormData();
  fd.append('arquivo', arquivoAtual);

  try {
    pf.style.width = '60%'; pl.textContent = 'Calculando roteirosâ€¦';
    const res = await fetch('/processar', { method: 'POST', body: fd });
    const data = await res.json();
    pf.style.width = '100%';

    if (!res.ok) {
      pw.style.display = 'none';
      showErr(data.erro || 'Erro desconhecido.');
      document.getElementById('btn-processar').disabled = false;
      return;
    }

    pw.style.display = 'none';
    pidAtual = data.pid;
    mostrarResultado(data);
    showOk(`${data.total} peÃ§as processadas com sucesso.`);
  } catch(e) {
    pw.style.display = 'none';
    showErr('Falha na comunicaÃ§Ã£o com o servidor.');
  }
  document.getElementById('btn-processar').disabled = false;
}

// â”€â”€ Mostrar resultado â”€â”€
const CHIP_COLORS = ['COR','BOR','XBOR','DUP','USI','FUR','CAX','MAR','XMAR','EXP'];

function renderRota(rota) {
  return rota.split(' > ').map((s,i,arr) =>
    `<span class="chip chip-${s}">${s}</span>` +
    (i < arr.length-1 ? '<span class="arrow">â€º</span>' : '')
  ).join(' ');
}

function mostrarResultado(data) {
  // Stats
  const rotas = data.resumo.length;
  document.getElementById('stats').innerHTML = `
    <div class="stat-box"><div class="num">${data.total}</div><div class="lbl">Total de peÃ§as</div></div>
    <div class="stat-box"><div class="num">${rotas}</div><div class="lbl">Tipos de roteiro</div></div>
  `;

  // Download
  document.getElementById('btn-download').onclick = () => {
    window.location.href = `/download/${pidAtual}`;
  };

  // Resumo roteiros
  const maxQtd = Math.max(...data.resumo.map(r => r.qtd));
  document.getElementById('roteiro-list').innerHTML = data.resumo.map(r => `
    <div class="roteiro-row">
      <div class="rota">${renderRota(r.roteiro)}</div>
      <div class="bar-wrap"><div class="bar-fill" style="width:${(r.qtd/maxQtd*100).toFixed(1)}%"></div></div>
      <div class="qtd">${r.qtd}</div>
    </div>
  `).join('');

  // PrÃ©via
  document.getElementById('previa-tbody').innerHTML = data.previa.map(p => `
    <tr>
      <td>${p['DESCRIÃ‡ÃƒO DA PEÃ‡A'] || ''}</td>
      <td><span class="badge badge-blue">${p['LOCAL'] || ''}</span></td>
      <td class="rota-cell">${p['ROTEIRO'] || ''}</td>
    </tr>
  `).join('');

  document.getElementById('resultado').style.display = 'block';
}

// â”€â”€ HistÃ³rico â”€â”€
async function carregarHistorico() {
  const tbody = document.getElementById('hist-tbody');
  tbody.innerHTML = '<tr><td colspan="5" class="hist-empty">Carregandoâ€¦</td></tr>';
  try {
    const res  = await fetch('/historico');
    const rows = await res.json();
    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="hist-empty">Nenhum pedido processado ainda.</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td><code style="font-size:.78rem;color:var(--muted)">${r.id}</code></td>
        <td>${r.nome}</td>
        <td>${r.data}</td>
        <td><span class="badge badge-blue">${r.total_pecas} peÃ§as</span></td>
        <td style="display:flex;gap:6px">
          <a href="/download/${r.id}" class="btn btn-success btn-sm">â¬‡ XLSX</a>
          <button class="btn btn-danger btn-sm" onclick="deletar('${r.id}')">âœ•</button>
        </td>
      </tr>
    `).join('');
  } catch(e) {
    tbody.innerHTML = '<tr><td colspan="5" class="hist-empty">Erro ao carregar histÃ³rico.</td></tr>';
  }
}

async function deletar(pid) {
  if (!confirm('Remover este registro do histÃ³rico?')) return;
  await fetch('/historico/' + pid, { method: 'DELETE' });
  carregarHistorico();
}
</script>
</body>
</html>
