<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roteiro de Produ√ß√£o ¬∑ PCP</title>
<style>
  :root {
    --bg:       #f0f2f5;
    --card:     #ffffff;
    --border:   #dde1e7;
    --primary:  #1a3a6b;
    --accent:   #2563eb;
    --success:  #16a34a;
    --danger:   #dc2626;
    --warn:     #d97706;
    --text:     #1e2532;
    --muted:    #6b7280;
    --font:     'Segoe UI', system-ui, sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }

  header {
    background: var(--primary);
    color: #fff;
    padding: 0 32px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,.18);
  }
  header h1 { font-size: 1rem; font-weight: 600; letter-spacing: .03em; }
  header span { font-size: .78rem; opacity: .65; }

  .tabs { display: flex; gap: 2px; background: var(--primary); padding: 0 32px; }
  .tab {
    padding: 10px 20px;
    font-size: .85rem;
    font-weight: 500;
    color: rgba(255,255,255,.6);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: .15s;
    user-select: none;
  }
  .tab:hover { color: #fff; }
  .tab.active { color: #fff; border-bottom-color: #60a5fa; }

  main { max-width: 1100px; margin: 32px auto; padding: 0 24px; }
  .panel { display: none; }
  .panel.active { display: block; }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 20px;
  }
  .card h2 { font-size: .95rem; font-weight: 600; color: var(--primary); margin-bottom: 16px; }

  .drop-area {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: .2s;
  }
  .drop-area:hover, .drop-area.over { border-color: var(--accent); background: #eff6ff; }
  .drop-area svg { width: 48px; height: 48px; color: var(--muted); margin-bottom: 12px; }
  .drop-area p { color: var(--muted); font-size: .88rem; }
  .drop-area strong { color: var(--accent); }
  #file-input { display: none; }
  #file-name { margin-top: 10px; font-size: .85rem; color: var(--accent); font-weight: 500; }

  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 9px 20px; border-radius: 6px; border: none;
    font-size: .88rem; font-weight: 600; cursor: pointer; transition: .15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-primary:disabled { background: #93c5fd; cursor: not-allowed; }
  .btn-sm { padding: 5px 12px; font-size: .78rem; font-weight: 500; }
  .btn-success { background: var(--success); color: #fff; }
  .btn-success:hover { background: #15803d; }
  .btn-danger  { background: transparent; color: var(--danger); border: 1px solid var(--danger); }

  #progress-wrap { display: none; margin-top: 16px; }
  .progress-bar { height: 6px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; width: 0%; background: var(--accent); border-radius: 99px; transition: width .3s; animation: pulse-bar 1.5s ease-in-out infinite; }
  @keyframes pulse-bar { 0%,100%{opacity:1} 50%{opacity:.6} }
  #progress-label { font-size: .8rem; color: var(--muted); margin-top: 6px; }

  .alert { display: none; padding: 12px 16px; border-radius: 6px; font-size: .85rem; margin-top: 16px; border-left: 4px solid; }
  .alert-err  { background: #fef2f2; border-color: var(--danger); color: #991b1b; }
  .alert-ok   { background: #f0fdf4; border-color: var(--success); color: #166534; }

  #resultado { display: none; }
  .stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
  .stat-box { flex: 1; min-width: 140px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; text-align: center; }
  .stat-box .num { font-size: 2rem; font-weight: 700; color: var(--primary); }
  .stat-box .lbl { font-size: .78rem; color: var(--muted); margin-top: 2px; }

  .roteiro-list { display: flex; flex-direction: column; gap: 8px; }
  .roteiro-row { display: flex; align-items: center; gap: 10px; font-size: .83rem; }
  .roteiro-row .rota { font-family: 'Consolas', monospace; color: var(--primary); flex: 1; }
  .roteiro-row .bar-wrap { flex: 2; height: 8px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
  .roteiro-row .bar-fill { height: 100%; background: var(--accent); border-radius: 99px; transition: width .5s; }
  .roteiro-row .qtd { width: 32px; text-align: right; color: var(--muted); font-weight: 600; }

  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: .82rem; }
  thead th { background: var(--primary); color: #fff; padding: 9px 12px; text-align: left; font-weight: 600; white-space: nowrap; }
  tbody tr:nth-child(even) { background: var(--bg); }
  tbody td { padding: 7px 12px; border-bottom: 1px solid var(--border); }
  td.rota-cell { font-family: 'Consolas', monospace; font-size: .78rem; color: var(--primary); font-weight: 600; background: #fffbeb; white-space: nowrap; }

  .chip { padding: 3px 10px; border-radius: 4px; font-size: .72rem; font-weight: 700; letter-spacing: .04em; }
  .chip-COR  { background:#dbeafe; color:#1e40af; }
  .chip-BOR  { background:#dcfce7; color:#166534; }
  .chip-XBOR { background:#d1fae5; color:#065f46; }
  .chip-DUP  { background:#fef9c3; color:#854d0e; }
  .chip-USI  { background:#ffedd5; color:#9a3412; }
  .chip-FUR  { background:#fee2e2; color:#991b1b; }
  .chip-CAX  { background:#f3e8ff; color:#6b21a8; }
  .chip-MAR  { background:#fce7f3; color:#9d174d; }
  .chip-XMAR { background:#fce7f3; color:#831843; }
  .chip-EXP  { background:#e0f2fe; color:#0c4a6e; }
  .arrow { color: #94a3b8; font-size: .8rem; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: .72rem; font-weight: 600; }
  .badge-blue { background: #dbeafe; color: #1e40af; }
</style>
</head>
<body>

<header>
  <h1>‚öô Roteiro de Produ√ß√£o ¬∑ PCP</h1>
  <span id="clock"></span>
</header>

<div class="tabs">
  <div class="tab active" onclick="showTab('upload')">Processar Arquivo</div>
  <div class="tab" onclick="showTab('historico')">Hist√≥rico</div>
</div>

<main>
  <div class="panel active" id="panel-upload">
    <div class="card">
      <h2>Upload do arquivo Dinabox</h2>
      <div class="drop-area" id="drop-area" onclick="document.getElementById('file-input').click()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
        </svg>
        <p>Arraste um arquivo aqui ou <strong>clique para selecionar</strong></p>
        <p style="margin-top:6px">CSV ¬∑ XLS ¬∑ XLSX exportado pelo Dinabox</p>
        <div id="file-name"></div>
      </div>
      <input type="file" id="file-input" accept=".csv,.xls,.xlsx">

      <div id="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div id="progress-label">Processando‚Ä¶</div>
      </div>

      <div class="alert alert-err" id="alert-err"></div>
      <div class="alert alert-ok"  id="alert-ok"></div>

      <div style="margin-top:18px; display:flex; gap:10px; align-items:center;">
        <button class="btn btn-primary" id="btn-processar" onclick="processar()" disabled>‚ñ∂ Gerar Roteiro</button>
      </div>
    </div>

    <div id="resultado">
      <div class="card">
        <h2>Resultado</h2>
        <div class="stats" id="stats"></div>
        <button class="btn btn-success" id="btn-download">‚¨á Baixar XLSX</button>
      </div>

      <div class="card">
        <h2>Distribui√ß√£o de Roteiros</h2>
        <div class="roteiro-list" id="roteiro-list"></div>
      </div>

      <div class="card">
        <h2>Pr√©via das pe√ßas <span style="font-weight:400;color:var(--muted);font-size:.8rem">(primeiras 50)</span></h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Descri√ß√£o da Pe√ßa</th>
                <th>Local</th>
                <th>OBS</th>
                <th>Roteiro</th>
              </tr>
            </thead>
            <tbody id="previa-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" id="panel-historico">
    <div class="card">
      <h2>Pedidos processados</h2>
      <table id="hist-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Arquivo</th>
            <th>Data</th>
            <th>Pe√ßas</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="hist-tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
function tick() {
  const d = new Date();
  document.getElementById('clock').textContent = d.toLocaleDateString('pt-BR') + '  ' + d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
}
tick(); setInterval(tick, 10000);

function showTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'historico') carregarHistorico();
}

const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
let arquivoAtual = null;
let pidAtual = null;

fileInput.addEventListener('change', () => { if (fileInput.files[0]) setFile(fileInput.files[0]); });

function setFile(f) {
  arquivoAtual = f;
  document.getElementById('file-name').textContent = 'üìÑ ' + f.name;
  document.getElementById('btn-processar').disabled = false;
  document.getElementById('resultado').style.display = 'none';
  document.getElementById('alert-err').style.display = 'none';
  document.getElementById('alert-ok').style.display = 'none';
}

async function processar() {
  if (!arquivoAtual) return;
  const fd = new FormData(); fd.append('arquivo', arquivoAtual);
  
  document.getElementById('progress-wrap').style.display = 'block';
  document.getElementById('btn-processar').disabled = true;

  try {
    const res = await fetch('/processar', { method: 'POST', body: fd });
    const data = await res.json();
    
    if (!res.ok) throw new Error(data.erro || 'Erro no servidor');

    pidAtual = data.pid;
    mostrarResultado(data);
    document.getElementById('alert-ok').textContent = `‚úì ${data.total} pe√ßas processadas.`;
    document.getElementById('alert-ok').style.display = 'block';
  } catch(e) {
    document.getElementById('alert-err').textContent = '‚ö† ' + e.message;
    document.getElementById('alert-err').style.display = 'block';
  } finally {
    document.getElementById('progress-wrap').style.display = 'none';
    document.getElementById('btn-processar').disabled = false;
  }
}

function renderRota(rota) {
  return rota.split(' > ').map((s,i,arr) => `<span class="chip chip-${s}">${s}</span>` + (i < arr.length-1 ? '<span class="arrow">‚Ä∫</span>' : '')).join(' ');
}

function mostrarResultado(data) {
  document.getElementById('stats').innerHTML = `
    <div class="stat-box"><div class="num">${data.total}</div><div class="lbl">Total de pe√ßas</div></div>
    <div class="stat-box"><div class="num">${data.resumo.length}</div><div class="lbl">Tipos de roteiro</div></div>
  `;

  document.getElementById('btn-download').onclick = () => window.location.href = `/download/${pidAtual}`;

  const maxQtd = Math.max(...data.resumo.map(r => r.qtd));
  document.getElementById('roteiro-list').innerHTML = data.resumo.map(r => `
    <div class="roteiro-row">
      <div class="rota">${renderRota(r.roteiro)}</div>
      <div class="bar-wrap"><div class="bar-fill" style="width:${(r.qtd/maxQtd*100).toFixed(1)}%"></div></div>
      <div class="qtd">${r.qtd}</div>
    </div>
  `).join('');

  document.getElementById('previa-tbody').innerHTML = data.previa.map(p => `
    <tr>
      <td>${p['DESCRI√á√ÉO DA PE√áA'] || ''}</td>
      <td><span class="badge badge-blue">${p['LOCAL'] || ''}</span></td>
      <td style="color:var(--muted); font-style:italic">${p['OBS'] || ''}</td>
      <td class="rota-cell">${p['ROTEIRO'] || ''}</td>
    </tr>
  `).join('');

  document.getElementById('resultado').style.display = 'block';
}

async function carregarHistorico() {
  const res = await fetch('/historico');
  const rows = await res.json();
  document.getElementById('hist-tbody').innerHTML = rows.map(r => `
    <tr>
      <td>${r.id}</td>
      <td>${r.nome}</td>
      <td>${r.data}</td>
      <td>${r.total_pecas}</td>
      <td><a href="/download/${r.id}">‚¨á</a></td>
    </tr>
  `).join('');
}
</script>
</body>
</html>